// concur4.d: Uses a shared int with atomicOp

import std.stdio, std.concurrency;
shared int nthreads = 4;

void main() {
    int low = 0, high = 100;
    
    // Spawn 4 threads
    foreach (i; 0..nthreads)
        spawn(&fun, thisTid, i+1, low, high);
 
    while (nthreads) 
        receive((int id, int num) {writeln(num," from thread ",id);});
}

void fun(Tid tid, int mytid, int low, int high) {
    foreach (i; low..high)
        tid.send(mytid,i);
    writeln("Thread ", mytid, " finished");
    atomicOp!"-="(nthreads,1);
}

/* Output:
0 from thread 1
1 from thread 1
2 from thread 1
3 from thread 1
4 from thread 1
5 from thread 1
6 from thread 1
7 from thread 1
8 from thread 1
9 from thread 1
10 from thread 1
11 from thread 1
12 from thread 1
13 from thread 1
14 from thread 1
15 from thread 1
16 from thread 1
17 from thread 1
18 from thread 1
19 from thread 1
20 from thread 1
21 from thread 1
22 from thread 1
23 from thread 1
24 from thread 1
25 from thread 1
26 from thread 1
27 from thread 1
28 from thread 1
29 from thread 1
30 from thread 1
31 from thread 1
32 from thread 1
33 from thread 1
34 from thread 1
35 from thread 1
36 from thread 1
37 from thread 1
38 from thread 1
39 from thread 1
40 from thread 1
41 from thread 1
0 from thread 2
42 from thread 1
1 from thread 2
43 from thread 1
2 from thread 2
0 from thread 3
44 from thread 1
3 from thread 2
1 from thread 3
0 from thread 4
45 from thread 1
4 from thread 2
2 from thread 3
1 from thread 4
46 from thread 1
5 from thread 2
3 from thread 3
2 from thread 4
47 from thread 1
6 from thread 2
4 from thread 3
3 from thread 4
48 from thread 1
7 from thread 2
5 from thread 3
4 from thread 4
49 from thread 1
8 from thread 2
6 from thread 3
5 from thread 4
50 from thread 1
9 from thread 2
7 from thread 3
6 from thread 4
51 from thread 1
10 from thread 2
8 from thread 3
7 from thread 4
52 from thread 1
11 from thread 2
9 from thread 3
8 from thread 4
53 from thread 1
12 from thread 2
10 from thread 3
9 from thread 4
54 from thread 1
13 from thread 2
11 from thread 3
10 from thread 4
55 from thread 1
14 from thread 2
12 from thread 3
11 from thread 4
56 from thread 1
15 from thread 2
13 from thread 3
12 from thread 4
57 from thread 1
16 from thread 2
14 from thread 3
13 from thread 4
58 from thread 1
17 from thread 2
15 from thread 3
14 from thread 4
59 from thread 1
18 from thread 2
16 from thread 3
15 from thread 4
60 from thread 1
19 from thread 2
17 from thread 3
16 from thread 4
61 from thread 1
20 from thread 2
18 from thread 3
17 from thread 4
62 from thread 1
21 from thread 2
19 from thread 3
18 from thread 4
63 from thread 1
22 from thread 2
20 from thread 3
19 from thread 4
64 from thread 1
23 from thread 2
21 from thread 3
20 from thread 4
65 from thread 1
24 from thread 2
22 from thread 3
21 from thread 4
66 from thread 1
25 from thread 2
23 from thread 3
22 from thread 4
67 from thread 1
26 from thread 2
24 from thread 3
23 from thread 4
68 from thread 1
27 from thread 2
25 from thread 3
24 from thread 4
69 from thread 1
28 from thread 2
26 from thread 3
25 from thread 4
70 from thread 1
29 from thread 2
27 from thread 3
26 from thread 4
71 from thread 1
30 from thread 2
28 from thread 3
27 from thread 4
72 from thread 1
31 from thread 2
29 from thread 3
28 from thread 4
73 from thread 1
32 from thread 2
30 from thread 3
29 from thread 4
74 from thread 1
33 from thread 2
31 from thread 3
30 from thread 4
75 from thread 1
34 from thread 2
32 from thread 3
31 from thread 4
76 from thread 1
35 from thread 2
33 from thread 3
32 from thread 4
77 from thread 1
36 from thread 2
34 from thread 3
33 from thread 4
78 from thread 1
37 from thread 2
35 from thread 3
34 from thread 4
79 from thread 1
38 from thread 2
36 from thread 3
35 from thread 4
80 from thread 1
39 from thread 2
37 from thread 3
36 from thread 4
81 from thread 1
40 from thread 2
38 from thread 3
37 from thread 4
82 from thread 1
41 from thread 2
39 from thread 3
38 from thread 4
83 from thread 1
42 from thread 2
40 from thread 3
39 from thread 4
84 from thread 1
43 from thread 2
41 from thread 3
40 from thread 4
85 from thread 1
44 from thread 2
42 from thread 3
41 from thread 4
86 from thread 1
45 from thread 2
43 from thread 3
42 from thread 4
87 from thread 1
46 from thread 2
44 from thread 3
43 from thread 4
88 from thread 1
47 from thread 2
45 from thread 3
44 from thread 4
89 from thread 1
48 from thread 2
46 from thread 3
45 from thread 4
90 from thread 1
49 from thread 2
47 from thread 3
46 from thread 4
91 from thread 1
50 from thread 2
48 from thread 3
47 from thread 4
92 from thread 1
51 from thread 2
49 from thread 3
48 from thread 4
93 from thread 1
52 from thread 2
50 from thread 3
49 from thread 4
94 from thread 1
53 from thread 2
51 from thread 3
50 from thread 4
95 from thread 1
54 from thread 2
52 from thread 3
51 from thread 4
96 from thread 1
55 from thread 2
53 from thread 3
52 from thread 4
97 from thread 1
56 from thread 2
54 from thread 3
53 from thread 4
98 from thread 1
57 from thread 2
Thread 1 finished
55 from thread 3
54 from thread 4
99 from thread 1
58 from thread 2
56 from thread 3
55 from thread 4
59 from thread 2
57 from thread 3
56 from thread 4
60 from thread 2
58 from thread 3
57 from thread 4
61 from thread 2
59 from thread 3
58 from thread 4
62 from thread 2
60 from thread 3
59 from thread 4
63 from thread 2
61 from thread 3
60 from thread 4
64 from thread 2
62 from thread 3
61 from thread 4
65 from thread 2
63 from thread 3
62 from thread 4
66 from thread 2
64 from thread 3
63 from thread 4
67 from thread 2
65 from thread 3
64 from thread 4
68 from thread 2
66 from thread 3
65 from thread 4
69 from thread 2
67 from thread 3
66 from thread 4
70 from thread 2
68 from thread 3
67 from thread 4
71 from thread 2
69 from thread 3
68 from thread 4
72 from thread 2
70 from thread 3
69 from thread 4
73 from thread 2
71 from thread 3
70 from thread 4
74 from thread 2
72 from thread 3
71 from thread 4
75 from thread 2
73 from thread 3
72 from thread 4
76 from thread 2
74 from thread 3
73 from thread 4
77 from thread 2
75 from thread 3
74 from thread 4
78 from thread 2
76 from thread 3
75 from thread 4
79 from thread 2
77 from thread 3
76 from thread 4
80 from thread 2
78 from thread 3
77 from thread 4
81 from thread 2
79 from thread 3
78 from thread 4
82 from thread 2
80 from thread 3
79 from thread 4
83 from thread 2
81 from thread 3
80 from thread 4
84 from thread 2
82 from thread 3
81 from thread 4
85 from thread 2
83 from thread 3
82 from thread 4
86 from thread 2
84 from thread 3
83 from thread 4
87 from thread 2
85 from thread 3
84 from thread 4
88 from thread 2
86 from thread 3
85 from thread 4
89 from thread 2
87 from thread 3
86 from thread 4
90 from thread 2
88 from thread 3
87 from thread 4
91 from thread 2
89 from thread 3
88 from thread 4
92 from thread 2
90 from thread 3
89 from thread 4
93 from thread 2
91 from thread 3
90 from thread 4
94 from thread 2
92 from thread 3
91 from thread 4
95 from thread 2
93 from thread 3
92 from thread 4
96 from thread 2
94 from thread 3
93 from thread 4
97 from thread 2
95 from thread 3
94 from thread 4
98 from thread 2
96 from thread 3
Thread 2 finished
95 from thread 4
99 from thread 2
97 from thread 3
96 from thread 4
98 from thread 3
Thread 3 finished
97 from thread 4
99 from thread 3
98 from thread 4
Thread 4 finished
99 from thread 4
*/